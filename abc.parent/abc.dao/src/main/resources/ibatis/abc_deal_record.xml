<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.autoserve.abc.dao.intf.DealRecordDao">
	<resultMap id="BaseResultMap" type="com.autoserve.abc.dao.dataobject.DealRecordDO">
		<id column="dr_id" property="drId" jdbcType="INTEGER" />
		<result column="dr_out_seq_no" property="drOutSeqNo" jdbcType="VARCHAR" />
		<result column="dr_inner_seq_no" property="drInnerSeqNo"
			jdbcType="VARCHAR" />
		<result column="dr_pay_account" property="drPayAccount"
			jdbcType="VARCHAR" />
		<result column="dr_receive_account" property="drReceiveAccount"
			jdbcType="VARCHAR" />
		<result column="dr_money_amount" property="drMoneyAmount"
			jdbcType="DECIMAL" />
		<result column="dr_detail_type" property="drDetailType"
			jdbcType="INTEGER" />
		<result column="dr_type" property="drType" jdbcType="INTEGER" />
		<result column="dr_business_id" property="drBusinessId"
			jdbcType="INTEGER" />
		<result column="dr_cash_id" property="drCashId" jdbcType="INTEGER" />
		<result column="dr_state" property="drState" jdbcType="INTEGER" />
		<result column="dr_operate_date" property="drOperateDate"
			jdbcType="TIMESTAMP" />
		<result column="dr_operator" property="drOperator" jdbcType="INTEGER" />
	</resultMap>
	<sql id="Base_Column_List">
		dr_id, dr_out_seq_no, dr_inner_seq_no, dr_pay_account, dr_receive_account,
		dr_money_amount,
		dr_detail_type, dr_type, dr_business_id, dr_cash_id, dr_state, dr_operate_date,
		dr_operator
	</sql>
	<select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from abc_deal_record
		where dr_id = #{drId,jdbcType=INTEGER}
	</select>

	<select id="findDealRecordsByInnerSeqNo" resultMap="BaseResultMap"
		parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from abc_deal_record
		where dr_inner_seq_no = #{innerSeqNo,jdbcType=VARCHAR}
	</select>
	
	<select id="findDealRecordsByInnerSeqNoAndType" resultMap="BaseResultMap"
		parameterType="map">
		select
		<include refid="Base_Column_List" />
		from abc_deal_record
		where dr_inner_seq_no = #{innerSeqNo,jdbcType=VARCHAR} and dr_detail_type =#{drDetailType,jdbcType=INTEGER}
	</select>
	
	
	
	<select id="findDealRecordsByInnerSeqNos" resultMap="BaseResultMap" parameterType="list">
	   select 
	   <include refid="Base_Column_List" />
	   from abc_deal_record
	   where dr_inner_seq_no in 
	   <foreach collection="list" close=")" index="index" item="item" open="(" separator=",">
	       #{item}
	   </foreach>
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from abc_deal_record
		where dr_id = #{drId,jdbcType=INTEGER}
	</delete>
	<insert id="batchInsert" parameterType="java.util.List">
		insert into abc_deal_record (dr_id, dr_out_seq_no, dr_inner_seq_no,
		dr_pay_account, dr_receive_account, dr_money_amount,
		dr_detail_type, dr_type, dr_business_id,
		dr_cash_id, dr_state, dr_operate_date,
		dr_operator) 
		values 
		<foreach collection="list" item="item" index="index" separator=",">
			(#{item.drId,jdbcType=INTEGER},	#{item.drOutSeqNo,jdbcType=VARCHAR},
			#{item.drInnerSeqNo,jdbcType=VARCHAR},
			#{item.drPayAccount,jdbcType=VARCHAR},
			#{item.drReceiveAccount,jdbcType=VARCHAR},
			#{item.drMoneyAmount,jdbcType=DECIMAL},
			#{item.drDetailType,jdbcType=INTEGER},
			#{item.drType,jdbcType=INTEGER},
			#{item.drBusinessId,jdbcType=INTEGER},
			#{item.drCashId,jdbcType=INTEGER},
			#{item.drState,jdbcType=INTEGER},
			now(),
			#{item.drOperator,jdbcType=INTEGER})
		</foreach>
	</insert>
	<insert id="insert" parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO">
		insert into abc_deal_record (dr_id, dr_out_seq_no, dr_inner_seq_no,
		dr_pay_account, dr_receive_account, dr_money_amount,
		dr_detail_type, dr_type, dr_business_id,
		dr_cash_id, dr_state, dr_operate_date,
		dr_operator)
		values (#{drId,jdbcType=INTEGER}, #{drOutSeqNo,jdbcType=VARCHAR},
		#{drInnerSeqNo,jdbcType=VARCHAR},
		#{drPayAccount,jdbcType=VARCHAR}, #{drReceiveAccount,jdbcType=VARCHAR},
		#{drMoneyAmount,jdbcType=DECIMAL},
		#{drDetailType,jdbcType=INTEGER}, #{drType,jdbcType=INTEGER}, #{drBusinessId,jdbcType=INTEGER},
		#{drCashId,jdbcType=INTEGER}, #{drState,jdbcType=INTEGER},
		#{drOperateDate,jdbcType=TIMESTAMP},
		#{drOperator,jdbcType=INTEGER})
	</insert>
	<insert id="insertSelective" parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO" >
    insert into abc_deal_record
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="drId != null" >
        dr_id,
      </if>
      <if test="drOutSeqNo != null" >
        dr_out_seq_no,
      </if>
      <if test="drInnerSeqNo != null" >
        dr_inner_seq_no,
      </if>
      <if test="drPayAccount != null" >
        dr_pay_account,
      </if>
      <if test="drReceiveAccount != null" >
        dr_receive_account,
      </if>
      <if test="drMoneyAmount != null" >
        dr_money_amount,
      </if>
      <if test="drDetailType != null" >
        dr_detail_type,
      </if>
      <if test="drType != null" >
        dr_type,
      </if>
      <if test="drBusinessId != null" >
        dr_business_id,
      </if>
      <if test="drCashId != null" >
        dr_cash_id,
      </if>
      <if test="drState != null" >
        dr_state,
      </if>
      <if test="drOperateDate != null" >
        dr_operate_date,
      </if>
      <if test="drOperator != null" >
        dr_operator,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="drId != null" >
        #{drId,jdbcType=INTEGER},
      </if>
      <if test="drOutSeqNo != null" >
        #{drOutSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drInnerSeqNo != null" >
        #{drInnerSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drPayAccount != null" >
        #{drPayAccount,jdbcType=VARCHAR},
      </if>
      <if test="drReceiveAccount != null" >
        #{drReceiveAccount,jdbcType=VARCHAR},
      </if>
      <if test="drMoneyAmount != null" >
        #{drMoneyAmount,jdbcType=DECIMAL},
      </if>
      <if test="drDetailType != null" >
        #{drDetailType,jdbcType=INTEGER},
      </if>
      <if test="drType != null" >
        #{drType,jdbcType=INTEGER},
      </if>
      <if test="drBusinessId != null" >
        #{drBusinessId,jdbcType=INTEGER},
      </if>
      <if test="drCashId != null" >
        #{drCashId,jdbcType=INTEGER},
      </if>
      <if test="drState != null" >
        #{drState,jdbcType=INTEGER},
      </if>
      <if test="drOperateDate != null" >
        #{drOperateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="drOperator != null" >
        #{drOperator,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
	<update id="updateDealRecordState" parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO">
		update abc_deal_record
    <set >
      <if test="drOutSeqNo != null" >
        dr_out_seq_no = #{drOutSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drInnerSeqNo != null" >
        dr_inner_seq_no = #{drInnerSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drPayAccount != null" >
        dr_pay_account = #{drPayAccount,jdbcType=VARCHAR},
      </if>
      <if test="drReceiveAccount != null" >
        dr_receive_account = #{drReceiveAccount,jdbcType=VARCHAR},
      </if>
      <if test="drMoneyAmount != null" >
        dr_money_amount = #{drMoneyAmount,jdbcType=DECIMAL},
      </if>
      <if test="drDetailType != null" >
        dr_detail_type = #{drDetailType,jdbcType=INTEGER},
      </if>
      <if test="drType != null" >
        dr_type = #{drType,jdbcType=INTEGER},
      </if>
      <if test="drBusinessId != null" >
        dr_business_id = #{drBusinessId,jdbcType=INTEGER},
      </if>
      <if test="drCashId != null" >
        dr_cash_id = #{drCashId,jdbcType=INTEGER},
      </if>
      <if test="drState != null" >
        dr_state = #{drState,jdbcType=INTEGER},
      </if>
      <if test="drOperateDate != null" >
        dr_operate_date = #{drOperateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="drOperator != null" >
        dr_operator = #{drOperator,jdbcType=INTEGER},
      </if>
    </set>
		where dr_inner_seq_no = #{drInnerSeqNo,jdbcType=VARCHAR}
	</update>
	
	<update id="updateByPrimaryKey" parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO">
		update abc_deal_record
		set dr_out_seq_no = #{drOutSeqNo,jdbcType=VARCHAR},
		dr_inner_seq_no = #{drInnerSeqNo,jdbcType=VARCHAR},
		dr_pay_account = #{drPayAccount,jdbcType=INTEGER},
		dr_receive_account = #{drReceiveAccount,jdbcType=INTEGER},
		dr_money_amount = #{drMoneyAmount,jdbcType=DECIMAL},
		dr_type = #{drType,jdbcType=INTEGER},
		dr_business_id = #{drBusinessId,jdbcType=INTEGER},
		dr_cash_id = #{drCashId,jdbcType=INTEGER},
		dr_state = #{drState,jdbcType=INTEGER},
		dr_operate_date = #{drOperateDate,jdbcType=TIMESTAMP},
		dr_operator = #{drOperator,jdbcType=INTEGER}
		where dr_id = #{drId,jdbcType=INTEGER}
	</update>
	
	<!-- 最近交易 -->
	<select id="findMyRecentDeal" resultType="com.autoserve.abc.dao.dataobject.stage.statistics.RecentDeal" 
		parameterType="map">
			select  t1.dr_operate_date as dealDate,t1.dr_money_amount as dealMoney,t1.dr_type as dealType,
			t1.dr_pay_account as drPayAccount,t1.dr_receive_account as drReceiveAccount,t1.dr_detail_type as detailType
			from abc_deal_record t1
			where t1.dr_type in(2,3,4,5) and t1.dr_state=1 and t1.dr_money_amount > 0
			and (t1.dr_pay_account = #{userId,jdbcType=VARCHAR}  or t1.dr_receive_account=#{userId,jdbcType=VARCHAR})
			ORDER BY t1.dr_operate_date DESC LIMIT 4
	</select>
		
	<!-- 2、资金划转 3、还款 -->
	<select id="findDealByParams" resultMap="BaseResultMap"
		parameterType="map">
		select  
		<include refid="Base_Column_List" />
		from 
		(
		select a.dr_id, a.dr_out_seq_no, a.dr_inner_seq_no,
		case when a.dr_pay_account like 'p%' then a.dr_pay_account
		else b.account_mark end as dr_pay_account,
		case when a.dr_receive_account like 'p%' then a.dr_receive_account
		else c.account_mark end as dr_receive_account,
		a.dr_money_amount, 
		a.dr_detail_type, a.dr_type, a.dr_business_id, a.dr_cash_id, a.dr_state, a.dr_operate_date, a.dr_operator  
		from abc_deal_record a
		left join abc_account_info b on a.dr_pay_account=b.account_no 
		left join abc_account_info c on a.dr_receive_account=c.account_no 
		)T1 
		where T1.dr_money_amount > 0 and T1.dr_type in (2,3) and T1.dr_state=1
		<if test="dealRecordDo != null">
		  <if test="dealRecordDo.drOutSeqNo != null" >
	       and T1.dr_out_seq_no =  #{dealRecordDo.drOutSeqNo,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drInnerSeqNo != null" >
	       and T1.dr_inner_seq_no =  #{dealRecordDo.drInnerSeqNo,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drPayAccount != null" >
	       and (T1.dr_pay_account =  #{dealRecordDo.drPayAccount,jdbcType=VARCHAR} or
	       T1.dr_receive_account =  #{dealRecordDo.drPayAccount,jdbcType=VARCHAR}
	       )
	      </if>
	      <if test="dealRecordDo.drReceiveAccount != null" >
	       and T1.dr_receive_account =  #{dealRecordDo.drReceiveAccount,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drMoneyAmount != null" >
	       and T1.dr_money_amount =  #{dealRecordDo.drMoneyAmount,jdbcType=DECIMAL}
	      </if>
	      <if test="dealRecordDo.drDetailType != null" >
	       and T1.dr_detail_type =  #{dealRecordDo.drDetailType,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drType != null" >
	       and T1.dr_type =  #{dealRecordDo.drType,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drBusinessId != null" >
	       and T1.dr_business_id =  #{dealRecordDo.drBusinessId,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drCashId != null" >
	       and T1.dr_cash_id =  #{dealRecordDo.drCashId,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drState != null" >
	       and T1.dr_state =  #{dealRecordDo.drState,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drOperateDate != null" >
	       and T1.dr_operate_date =  #{dealRecordDo.drOperateDate,jdbcType=TIMESTAMP}
	      </if>
	      <if test="dealRecordDo.drOperator != null" >
	       and T1.dr_operator =  #{dealRecordDo.drOperator,jdbcType=INTEGER}
	      </if>
	    </if>
	    <if test="startDate != null or endDate != null">
			and T1.dr_operate_date between
			<choose>
				<when test="startDate != null">
					#{startDate,jdbcType=TIMESTAMP}
				</when>
				<otherwise>'1970-01-01'</otherwise>
			</choose>
			and
			<choose>
				<when test="endDate != null">
					#{endDate,jdbcType=TIMESTAMP}
				</when>
				<otherwise>now()</otherwise>
			</choose>
		</if>
     	order by T1.dr_operate_date desc
       <if test="pageCondition != null">
            limit #{pageCondition.pageOffset,jdbcType=INTEGER}, #{pageCondition.pageSize,jdbcType=INTEGER}
        </if>
	</select>
	
	<select id="countDealByParams" resultType="int"
		parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO">
		select  
		count(*)
			from 
		(
		select a.dr_id, a.dr_out_seq_no, a.dr_inner_seq_no,
		case when a.dr_pay_account like 'p%' then a.dr_pay_account
		else b.account_mark end as dr_pay_account,
		case when a.dr_receive_account like 'p%' then a.dr_receive_account
		else c.account_mark end as dr_receive_account,
		a.dr_money_amount, 
		a.dr_detail_type, a.dr_type, a.dr_business_id, a.dr_cash_id, a.dr_state, a.dr_operate_date, a.dr_operator  
		from abc_deal_record a
		left join abc_account_info b on a.dr_pay_account=b.account_no 
		left join abc_account_info c on a.dr_receive_account=c.account_no 
		)T1 
		where T1.dr_money_amount > 0 and  T1.dr_type in (2,3) and T1.dr_state=1
		<if test="dealRecordDo != null">
		  <if test="dealRecordDo.drOutSeqNo != null" >
	       and T1.dr_out_seq_no =  #{dealRecordDo.drOutSeqNo,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drInnerSeqNo != null" >
	       and T1.dr_inner_seq_no =  #{dealRecordDo.drInnerSeqNo,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drPayAccount != null" >
	       and (T1.dr_pay_account =  #{dealRecordDo.drPayAccount,jdbcType=VARCHAR} or
	       T1.dr_receive_account =  #{dealRecordDo.drPayAccount,jdbcType=VARCHAR}
	       )
	      </if>
	      <if test="dealRecordDo.drReceiveAccount != null" >
	       and T1.dr_receive_account =  #{dealRecordDo.drReceiveAccount,jdbcType=VARCHAR}
	      </if>
	      <if test="dealRecordDo.drMoneyAmount != null" >
	       and T1.dr_money_amount =  #{dealRecordDo.drMoneyAmount,jdbcType=DECIMAL}
	      </if>
	      <if test="dealRecordDo.drDetailType != null" >
	       and T1.dr_detail_type =  #{dealRecordDo.drDetailType,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drType != null" >
	       and T1.dr_type =  #{dealRecordDo.drType,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drBusinessId != null" >
	       and T1.dr_business_id =  #{dealRecordDo.drBusinessId,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drCashId != null" >
	       and T1.dr_cash_id =  #{dealRecordDo.drCashId,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drState != null" >
	       and T1.dr_state =  #{dealRecordDo.drState,jdbcType=INTEGER}
	      </if>
	      <if test="dealRecordDo.drOperateDate != null" >
	       and T1.dr_operate_date =  #{dealRecordDo.drOperateDate,jdbcType=TIMESTAMP}
	      </if>
	      <if test="dealRecordDo.drOperator != null" >
	       and T1.dr_operator =  #{dealRecordDo.drOperator,jdbcType=INTEGER}
	      </if>
	    </if>
	    <if test="startDate != null or endDate != null">
			and T1.dr_operate_date between
			<choose>
				<when test="startDate != null">
					#{startDate,jdbcType=TIMESTAMP}
				</when>
				<otherwise>'1970-01-01'</otherwise>
			</choose>
			and
			<choose>
				<when test="endDate != null">
					#{endDate,jdbcType=TIMESTAMP}
				</when>
				<otherwise>now()</otherwise>
			</choose>
		</if>
     	order by T1.dr_operate_date desc
	</select>
	
	<update id="updateDealRecordStateById" parameterType="com.autoserve.abc.dao.dataobject.DealRecordDO">
		update abc_deal_record
    <set >
      <if test="drOutSeqNo != null" >
        dr_out_seq_no = #{drOutSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drInnerSeqNo != null" >
        dr_inner_seq_no = #{drInnerSeqNo,jdbcType=VARCHAR},
      </if>
      <if test="drPayAccount != null" >
        dr_pay_account = #{drPayAccount,jdbcType=VARCHAR},
      </if>
      <if test="drReceiveAccount != null" >
        dr_receive_account = #{drReceiveAccount,jdbcType=VARCHAR},
      </if>
      <if test="drMoneyAmount != null" >
        dr_money_amount = #{drMoneyAmount,jdbcType=DECIMAL},
      </if>
      <if test="drDetailType != null" >
        dr_detail_type = #{drDetailType,jdbcType=INTEGER},
      </if>
      <if test="drType != null" >
        dr_type = #{drType,jdbcType=INTEGER},
      </if>
      <if test="drBusinessId != null" >
        dr_business_id = #{drBusinessId,jdbcType=INTEGER},
      </if>
      <if test="drCashId != null" >
        dr_cash_id = #{drCashId,jdbcType=INTEGER},
      </if>
      <if test="drState != null" >
        dr_state = #{drState,jdbcType=INTEGER},
      </if>
      <if test="drOperateDate != null" >
        dr_operate_date = #{drOperateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="drOperator != null" >
        dr_operator = #{drOperator,jdbcType=INTEGER},
      </if>
    </set>
		where dr_id = #{drId,jdbcType=INTEGER}
	</update>
</mapper>
